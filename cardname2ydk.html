<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Class Extractor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            box-sizing: border-box;
            font-family: monospace;
        }

        .output-container {
            display: flex;
            gap: 20px;
        }

        .output-box {
            flex: 1;
            min-height: 200px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #f5f5f5;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .output-box ul {
            margin: 0;
            padding-left: 20px;
        }

        .output-box li {
            line-height: 1.8;
            margin: 0;
            padding: 0;
            font-size: 16px;
        }

        h1 {
            color: #333;
        }

        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #45a049;
        }

        a {
            color: #0066cc;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Automatically Retrieve the Card Key for the YGO Deck</h1>
        <textarea id="htmlInput" placeholder="Paste your HTML code here..."></textarea>
        <button onclick="extractTitles()">Get card name&card key</button>

        <div class="output-container">
            <div class="output-box">
                <h3>Matched card name</h3>
                <div id="titleOutput"></div>
            </div>
            <div class="output-box">
                <h3>card key and CN name</h3>
                <div id="urlOutput"></div>
            </div>
        </div>
    </div>

    <script>
        function extractTitles() {
            const htmlInput = document.getElementById('htmlInput').value;
            const titleOutput = document.getElementById('titleOutput');
            const urlOutput = document.getElementById('urlOutput');

            // Create a temporary DOM element to parse the HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlInput, 'text/html');

            // Find all tr elements with class "row"
            const rowElements = doc.querySelectorAll('tr.row');

            // Clear outputs
            const titleList = document.createElement('ul');
            const urlList = document.createElement('ul');
            const idArray = []; // 存储所有id

            let fetchCount = 0; // 统计已完成的fetch数量

            rowElements.forEach(tr => {
                const span = tr.querySelector('.card_name .icon span');
                if (span && span.textContent.trim()) {
                    const title = span.textContent.trim();
                    // Add to title list
                    const li = document.createElement('li');
                    li.textContent = title;
                    titleList.appendChild(li);

                    const url = `https://ygocdb.com/api/v0/?search=${encodeURIComponent(title)}`;

                    fetch(url, { method: 'GET' })
                        .then(response => response.json())
                        .then(json => {
                            const urlLi = document.createElement('li');
                            if (json.result && Array.isArray(json.result) && json.result.length > 0) {
                                const first = json.result[0];
                                urlLi.textContent = `ID: ${first.id}，名称: ${first.cn_name}`;
                                idArray.push(first.id); // 存id
                            } else {
                                urlLi.textContent = '未找到结果';
                            }
                            urlList.appendChild(urlLi);
                        })
                        .catch(error => {
                            const errorLi = document.createElement('li');
                            errorLi.textContent = `请求失败: ${error}`;
                            urlList.appendChild(errorLi);
                        })
                        .finally(() => {
                            fetchCount++;
                            // 当所有fetch都完成时，复制id到剪切板
                            if (fetchCount === titleList.children.length) {
                                if (idArray.length > 0) {
                                    const ids = idArray.join('\n');
                                    navigator.clipboard.writeText(ids).then(() => {
                                        const notice = document.createElement('div');
                                        notice.textContent = '所有ID已复制到剪切板！';
                                        notice.style.position = 'fixed';
                                        notice.style.bottom = '30px';
                                        notice.style.right = '30px';
                                        notice.style.background = '#4CAF50';
                                        notice.style.color = 'white';
                                        notice.style.padding = '12px 24px';
                                        notice.style.borderRadius = '6px';
                                        notice.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                                        notice.style.zIndex = 9999;
                                        document.body.appendChild(notice);
                                        setTimeout(() => {
                                            notice.remove();
                                        }, 2000);
                                    });
                                }
                            }
                        });
                }
            });

            if (titleList.children.length === 0) {
                titleOutput.textContent = 'No titles found on tr.row elements.';
                urlOutput.textContent = 'No URLs generated.';
            } else {
                titleOutput.appendChild(titleList);
                urlOutput.appendChild(urlList);
            }
        }
    </script>
</body>

</html>